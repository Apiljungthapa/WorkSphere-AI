<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered EMS</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', path='/emp_details.css') }}">

   
</head>

<body class="gradient-bg min-h-screen p-4 md:p-8">
    <div class="container mx-auto">
        <div class="max-w-6xl mx-auto space-y-8">
            <header class="flex flex-col md:flex-row items-center justify-between">
                <a href="{{ url_for('dashboard') }}"
                    class="bg-red-500 text-white hover:bg-green-700 transition-colors flex items-center px-4 py-2 rounded-md mb-4 md:mb-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back
                </a>
            </header>

            <div class="card-gradient rounded-lg shadow-xl overflow-hidden">
                <div class="header-gradient text-white p-4 md:p-6 rounded-t-lg">
                    <div class="flex flex-col md:flex-row justify-between items-center">
                        <h2 class="text-xl md:text-2xl font-bold mb-4 md:mb-0">{{ department_name }}</h2>
                        <div class="flex items-center space-x-2 bg-white/20 rounded-full px-4 py-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            <span>{{ total_employees }} Employees</span>
                        </div>
                    </div>
                </div>
                <div class="p-4 md:p-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                        
                        <a href="/assignment" class="block">
                            <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow p-4 md:p-6">
                                <h3 class="text-lg md:text-xl font-semibold text-indigo-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                    </svg>
                                    Tasks
                                </h3>
                                <p class="text-sm text-gray-600 mt-2">View and submit your Tasks </p>
                            </div>
                        </a>

                        <a href="/feed" class="chat-link">
                            <div class="chat-card">
                              <span class="counter" id="unread-count">2</span>
                              <h3 class="chat-title">
                                <svg xmlns="http://www.w3.org/2000/svg" class="chat-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                                Chat
                              </h3>
                              <p class="chat-description">Communicate with your colleagues</p>
                            </div>
                          </a>


                        <a href="/employee-details" class="block">
                            <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow p-4 md:p-6">
                                <h3 class="text-lg md:text-xl font-semibold text-indigo-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                    Employees
                                </h3>
                                <p class="text-sm text-gray-600 mt-2">View employee information and roles</p>
                            </div>
                        </a>



                        <a href="/summary" class="block">
                            <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow p-4 md:p-6">
                                <h3 class="text-lg md:text-xl font-semibold text-indigo-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 17v5m0 0H5a2 2 0 01-2-2v-3m6 0h6a2 2 0 002-2V7m0 5h.01M21 12h-6m0 0l3 3m-3-3l3-3" />
                                    </svg>
                                    Generate Summary
                                </h3>
                                <p class="text-sm text-gray-600 mt-2">Upload and Get summary from documents</p>
                            </div>
                        </a>


                        <a href="slide.html" class="block">
                            <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow p-4 md:p-6">
                                <h3 class="text-lg md:text-xl font-semibold text-indigo-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 2h8a2 2 0 012 2v16a2 2 0 01-2 2H8a2 2 0 01-2-2V4a2 2 0 012-2zm2 6h4m-4 4h4m-4 4h4M6 8h12M6 12h12M6 16h12"/>
                                        <polygon points="14,11 19,14 14,17" fill="currentColor"/>
                                    </svg>
                                    Generate Slide
                                </h3>
                                <p class="text-sm text-gray-600 mt-2">Generate Your presentation slide</p>
                            </div>
                        </a>


                        <a href="/rag" class="block">
                            <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow p-4 md:p-6">
                                <h3 class="text-lg md:text-xl font-semibold text-indigo-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 2h8a2 2 0 012 2v16a2 2 0 01-2 2H8a2 2 0 01-2-2V4a2 2 0 012-2zm2 6h4m-4 4h4m-4 4h4M6 8h12M6 12h12M6 16h12"/>
                                        <polygon points="14,11 19,14 14,17" fill="currentColor"/>
                                    </svg>
                                    Rag Query
                                </h3>
                                <p class="text-sm text-gray-600 mt-2">Query Your document</p>
                            </div>
                        </a>

                        
                    </div>
                </div>
            </div>



            <div class="card-gradient rounded-lg shadow-xl overflow-hidden">

            {% if message %}
                <div class="alert custom-alert alert-dismissible fade show" role="alert">
                    <strong>{{ message }}</strong>
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endif %}


                <div class="p-4 md:p-6">
                    <h2 class="text-xl md:text-2xl font-bold text-indigo-800 mb-6">All Posts</h2>
                    <div class="space-y-6">
                        <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
                            <h3 class="text-lg md:text-xl font-semibold text-indigo-600 mb-4">Create Post</h3>

               
                <form method="post" action="/posts/">
                    <input type="text" name="title" placeholder="Post Title"
                        class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4" required>
                    
                    <textarea name="content" placeholder="Write your post here..."
                            class="w-full min-h-[100px] p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 mb-4" required></textarea>
                    
                    <div class="flex flex-col sm:flex-row justify-between mt-4">
                        <button type="submit" class="btn-gradient text-white px-4 py-2 rounded-md w-full sm:w-auto">Create Post</button>
                    </div>
                </form>     
            </div>


            <div class="space-y-6">
                {% for post in posts %}
                <div class="post-container post-container--enhanced rounded-lg shadow-md p-6">
                    <div class="post-container__header mb-4 flex items-center">
                        
                        <span class="avatar">{{ post.initials }}</span>
                       
                        <div>
                            <h3 class="post-title post-title--large text-lg md:text-xl font-semibold text-indigo-600">{{ post.title }}</h3>
                            <p class="post-creator text-sm text-gray-500">by <span class="font-medium text-indigo-500">{{ post.full_name }}</span></p>
                        </div>
                    </div>
                    
                    <p class="post-content post-content--main text-gray-700 mb-4">{{ post.content }}</p>
                
                    <div class="post-date post-date--styled mb-4">
                        <span class="post-date__label font-medium">Post Date:</span>
                        <span class="post-date__value text-indigo-500">{{ post.created_date }}</span>
                    </div>
                
                    <!-- Post actions (Edit, Delete, Like) -->

                    <div class="post-actions flex flex-col sm:flex-row justify-between items-center mb-4">
                        <div class="post-actions__edit-delete flex space-x-2 mb-2 sm:mb-0">
                            <!-- Show Edit and Delete buttons only for the author -->
                            {% if user_id == post.user_id %}
                                <a href="{{ url_for('post_edit_page', post_id=post.post_id) }}" class="post-actions__edit">
                                    <button class="btn-outline btn-outline--edit px-3 py-1 rounded-md flex items-center hover:bg-indigo-100 transition duration-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                        Edit
                                    </button>
                                </a>
                    
                                <a href="/post/delete/{{ post.post_id }}" class="post-actions__delete">
                                    <button class="btn-outline btn-outline--delete px-3 py-1 rounded-md flex items-center hover:bg-red-100 transition duration-300">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                        </svg>
                                        Delete
                                    </button>
                                </a>
                            {% endif %}
                        </div>
                    
                        <div class="post-actions__stats flex items-center space-x-4">
                            <span class="post-actions__comments text-sm text-gray-500">{{ post.comments|length }} comments</span>
                            <span id="like-count-{{ post.post_id }}" class="post-actions__likes text-sm text-gray-500">{{ post.likes }} likes</span>
                            <button
                                id="like-button-{{ post.post_id }}"
                                class="fb-like-button fb-like-button--custom flex items-center space-x-1 {{ 'bg-blue-500 text-white' if post.is_liked else 'text-gray-500' }}"
                                aria-label="Like"
                                onclick="toggleLike(this, '{{ post.post_id }}')"
                                data-liked="{{ is_liked|lower }}">
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-4 w-4"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                                </svg>
                                <span class="like-text">{{ "Liked" if post.is_liked else "Like" }}</span>
                            </button>
                        </div>
                    </div>
                    

                    <div class="post-comments">
                        <h4 class="post-comments__title">Comments</h4>
                
                        <ul class="post-comments__list">
                            {% for comment in comments_by_post[post.post_id] %}
                            <li class="comment">
                                <div class="avatar">{{ comment.initials }}</div>
                                <div class="comment__content">
                                    <p class="comment__text">{{ comment.content }}</p>
                                    <div class="comment__meta">
                                        <span class="comment__author">{{ comment.full_name }}</span>
                                        <span class="comment__date">{{ comment.comment_date }}</span>
                                    </div>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                
                        <form action="/comments/" method="post" class="comment-form">
                            <input 
                                type="text" 
                                name="content" 
                                placeholder="Add a comment..." 
                                class="comment-form__input" 
                                required>
                            
                            <input type="hidden" name="post_id" value="{{ post.post_id }}">
                        
                            <button 
                                type="submit" 
                                class="comment-form__submit">
                                Add Comment
                            </button>
                        </form>
                    </div>
                
                </div>
                
                
                {% else %}
                <p>No posts available.</p>
                {% endfor %}
            </div>
            


            <!-- <div class="space-y-6">
                {% for post in posts %}
                <div class="post-gradient rounded-lg shadow-md p-4 md:p-6">
                    <h3 class="text-lg md:text-xl font-semibold text-indigo-600 mb-4">{{ post.title }}</h3>
                    <p class="text-gray-700 mb-4">{{ post.content }}</p>
        
                    <div class="flex flex-col sm:flex-row justify-between items-center">
                        <div class="flex space-x-2 mb-2 sm:mb-0">
                            <a href="{{ url_for('post_edit_page', post_id=post.post_id) }}">
                                <button class="btn-outline px-3 py-1 rounded-md flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                    Edit
                                </button>
                            </a>
                            
        
                            <a href="/post/delete/{{ post.post_id }}" class="btn-outline px-3 py-1 rounded-md flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete
                            </a>
                            
                            
                        </div>
                        <a href="/post/like/{{ post.post_id }}" class="btn-outline px-3 py-1 rounded-md flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5" />
                            </svg>
                            Like ({{ post.likes_count }})
                        </a>
                        
        
                    <div class="mt-4">
                        <h4 class="text-lg font-semibold text-indigo-600 mb-2">Comments</h4>
                        <ul class="space-y-2">
                            {% for comment in post.comments %}
                            <li class="bg-gray-100 p-2 rounded">
                                <p>"{{ comment.text }}" - {{ comment.user.name }}</p>
                                <span class="text-sm text-gray-500">Posted on: {{ comment.created_at }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                        <div class="mt-2">
                            <input type="text" placeholder="Add a comment..." class="w-full p-2 border border-gray-300 rounded-md">
                            <button class="mt-2 btn-gradient text-white px-3 py-1 rounded-md">Add Comment</button>
                        </div>
                    </div>
                </div>
                {% else %}
                <p>No posts available.</p>
                {% endfor %}
            </div>
            


            
        </div> -->






                </div>
            </div>
        </div>
    </div>
</body>
<script>

   async function fetchUnreadCount() {
        const response = await fetch('/total_unread', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${document.cookie.access_token}`
            }
        });
        const data = await response.json();
        const unreadCount = data.total_unread;
        document.getElementById("unread-count").textContent = unreadCount;
    }

    // Call fetchUnreadCount initially
    fetchUnreadCount();

    // WebSocket connection to listen for real-time updates
    const socket = new WebSocket("ws://127.0.0.1:8000/ws/{{ user_id }}");

    socket.onmessage = function(event) {
        const message = JSON.parse(event.data);
        if (message.type === "new_message") {
            // Fetch unread count again after receiving a new message
            fetchUnreadCount();
        }
    };

function getRandomColor() {
            const hue = Math.floor(Math.random() * 360);
            return `hsl(${hue}, 70%, 50%)`;
        }

        function setAvatarColors() {
            const avatars = document.querySelectorAll('.avatar');
            avatars.forEach(avatar => {
                avatar.style.backgroundColor = getRandomColor();
            });
        }

        // Set initial colors
        setAvatarColors();

        // Optionally, set new colors every time the page is loaded
        window.addEventListener('load', setAvatarColors);

 async function toggleLike(button, postId) {
    const isLiked = button.getAttribute("data-liked") === "true"; // Check current like state
    const likeCountSpan = document.getElementById(`like-count-${postId}`);
    
    try {
        // Send a request to toggle the like state (like/unlike)
        const response = await fetch(`/post/${isLiked ? "unlike" : "like"}/${postId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
        });

        if (response.ok) {
            const data = await response.json();  // Get the new like count from the response
            
            // Update like count in UI
            likeCountSpan.textContent = `${data.likes} likes`;

            // Toggle the button's state and appearance
            if (isLiked) {
                button.setAttribute("data-liked", "false"); // Mark as unliked
                button.querySelector(".like-text").textContent = "Like"; // Change button text
                // button.classList.remove("bg-blue-500", "text-white"); // Remove 'liked' styles
                // button.classList.add("text-gray-500"); // Change to default like style
            } else {
                button.setAttribute("data-liked", "true"); // Mark as liked
                button.querySelector(".like-text").textContent = "Liked"; // Change button text
                // button.classList.add("bg-blue-500", "text-white"); // Add 'liked' styles
                // button.classList.remove("text-gray-500"); // Remove default like style
            }
        } else {
            console.error("Error toggling like/unlike");
        }
    } catch (error) {
        console.error("Error while toggling like:", error);
    }
}

</script>
</html>